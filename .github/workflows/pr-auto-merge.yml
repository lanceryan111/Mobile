- name: Check PR Status Before Merge
  id: check_pr_status
  run: |
    echo "ğŸ” Checking PR #${{ github.event.pull_request.number }} status..."
    
    API_URL="${{ github.event.pull_request.url }}"
    MAX_RETRIES=5
    RETRY_DELAY=3
    
    for i in $(seq 1 $MAX_RETRIES); do
      echo "Attempt $i/$MAX_RETRIES..."
      
      body=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   -H "Accept: application/vnd.github.v3+json" \
                   "$API_URL")
      
      echo "API URL: $API_URL"
      echo "HTTP status code: $(curl -s -o /dev/null -w '%{http_code}' \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$API_URL")"
      
      state=$(echo "$body" | jq -r '.state')
      mergeable=$(echo "$body" | jq -r '.mergeable')
      mergeable_state=$(echo "$body" | jq -r '.mergeable_state')
      
      echo "PR State: $state"
      echo "Mergeable: $mergeable"
      echo "Mergeable State: $mergeable_state"
      
      # å¦‚æœ mergeable ä¸æ˜¯ nullï¼Œè·³å‡ºå¾ªç¯
      if [[ "$mergeable" != "null" && "$mergeable" != "" ]]; then
        echo "âœ… Got valid mergeable status"
        break
      fi
      
      if [[ $i -lt $MAX_RETRIES ]]; then
        echo "â³ Mergeable status is null/unknown, retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
      else
        echo "âŒ Failed to get mergeable status after $MAX_RETRIES attempts"
        exit 1
      fi
    done
    
    # æ£€æŸ¥ PR çŠ¶æ€
    if [[ "$state" != "open" ]]; then
      echo "âŒ PR is not open (state: $state)"
      exit 1
    fi
    
    # æ£€æŸ¥æ˜¯å¦å¯åˆå¹¶
    if [[ "$mergeable" != "true" ]]; then
      echo "âŒ PR is not mergeable (mergeable: $mergeable, state: $mergeable_state)"
      exit 1
    fi
    
    echo "âœ… PR is open and ready for merge"
    echo "MERGEABLE_CHECK=true" >> $GITHUB_OUTPUT

- name: Merge Pull Request
  if: ${{ steps.check_pr_status.outputs.MERGEABLE_CHECK == 'true' }}
  run: |
    echo "ğŸš€ Attempting to merge PR #${{ inputs.pull_number }} using ${{ inputs.merge_method }} method..."
    
    MERGE_API_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/pulls/${{ inputs.pull_number }}/merge"
    echo "Merge URL: $MERGE_API_URL"
    
    MAX_RETRIES=3
    RETRY_DELAY=2
    MERGED=false
    
    for i in $(seq 1 $MAX_RETRIES); do
      echo "----------------------------------------"
      echo "Merge attempt $i/$MAX_RETRIES..."
      
      http_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -L \
        -X PUT \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "$MERGE_API_URL" \
        -d '{
          "commit_title": "Auto merge PR #${{ inputs.pull_number }}",
          "commit_message": "Merged via GitHub Actions workflow test",
          "merge_method": "${{ inputs.merge_method }}"
        }')
      
      http_code=$(echo "$http_response" | grep "HTTP_CODE:" | cut -d: -f2)
      body=$(echo "$http_response" | grep -v "HTTP_CODE:")
      
      echo "Response Code: $http_code"
      echo "Response Body: $body"
      
      # æ£€æŸ¥ HTTP çŠ¶æ€ç 
      if [[ "$http_code" == "200" ]]; then
        echo "âœ… PR merged successfully (HTTP 200)"
        MERGED=true
        break
      elif [[ "$http_code" == "405" ]]; then
        # 405 å¯èƒ½æ„å‘³ç€ PR å·²ç»è¢«åˆå¹¶äº†
        echo "âš ï¸ Got HTTP 405 - checking if PR is already merged..."
        
        # æ£€æŸ¥ PR çŠ¶æ€
        pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                         -H "Accept: application/vnd.github+json" \
                         "${{ github.event.pull_request.url }}")
        
        merged=$(echo "$pr_status" | jq -r '.merged')
        pr_state=$(echo "$pr_status" | jq -r '.state')
        
        echo "PR merged status: $merged"
        echo "PR state: $pr_state"
        
        if [[ "$merged" == "true" ]]; then
          echo "âœ… PR is already merged!"
          MERGED=true
          break
        else
          echo "âŒ PR is not merged and got 405 error"
        fi
      elif [[ "$http_code" == "409" ]]; then
        echo "âš ï¸ Merge conflict detected (HTTP 409)"
        echo "âŒ Cannot merge due to conflicts"
        exit 1
      elif [[ "$http_code" == "" || "$http_code" == "null" ]]; then
        echo "âš ï¸ Empty response code, checking PR merge status..."
        
        # æ£€æŸ¥ PR æ˜¯å¦å®é™…è¢«åˆå¹¶äº†
        sleep 2
        pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                         -H "Accept: application/vnd.github+json" \
                         "${{ github.event.pull_request.url }}")
        
        merged=$(echo "$pr_status" | jq -r '.merged')
        
        if [[ "$merged" == "true" ]]; then
          echo "âœ… PR was successfully merged (verified by status check)"
          MERGED=true
          break
        else
          echo "â³ PR not merged yet, will retry..."
        fi
      else
        echo "âš ï¸ Unexpected HTTP code: $http_code"
      fi
      
      if [[ $i -lt $MAX_RETRIES ]]; then
        echo "â³ Retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
      fi
    done
    
    # æœ€ç»ˆéªŒè¯
    if [[ "$MERGED" == "false" ]]; then
      echo "----------------------------------------"
      echo "ğŸ” Final verification: checking PR merge status..."
      
      pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                       -H "Accept: application/vnd.github+json" \
                       "${{ github.event.pull_request.url }}")
      
      merged=$(echo "$pr_status" | jq -r '.merged')
      merge_commit_sha=$(echo "$pr_status" | jq -r '.merge_commit_sha')
      
      if [[ "$merged" == "true" ]]; then
        echo "âœ… PR #${{ inputs.pull_number }} is confirmed merged!"
        echo "Merge commit: $merge_commit_sha"
        MERGED=true
      else
        echo "âŒ Failed to merge PR after $MAX_RETRIES attempts"
        exit 1
      fi
    fi
    
    if [[ "$MERGED" == "true" ]]; then
      echo "========================================="
      echo "ğŸ‰ PR #${{ inputs.pull_number }} successfully merged!"
      echo "========================================="
    fi

è¿™æ˜¯ä¸€ä¸ªå¾ˆå¸¸è§çš„ GitHub API é—®é¢˜ï¼`mergeable` å’Œ `mergeable_state` å­—æ®µç»å¸¸åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶è¿”å› `null` æˆ– `unknown`ã€‚

**åŸå› ï¼š**

GitHub éœ€è¦**å¼‚æ­¥è®¡ç®—** PR çš„å¯åˆå¹¶çŠ¶æ€ã€‚å½“ä½ ç¬¬ä¸€æ¬¡è¯·æ±‚ PR ä¿¡æ¯æ—¶ï¼š

1. GitHub API ç«‹å³è¿”å›å“åº”ï¼ˆ`mergeable: null`, `mergeable_state: unknown`ï¼‰
1. GitHub åœ¨åå°å¼€å§‹è®¡ç®—åˆå¹¶çŠ¶æ€ï¼ˆæ£€æŸ¥å†²çªã€CI çŠ¶æ€ç­‰ï¼‰
1. å‡ ç§’é’Ÿåï¼Œè®¡ç®—å®Œæˆï¼Œå†æ¬¡è¯·æ±‚å°±èƒ½å¾—åˆ°æ­£ç¡®çš„å€¼

**è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ é‡è¯•é€»è¾‘**

```yaml
- name: Check PR Status Before Merge
  id: check_pr_status
  run: |
    echo "ğŸ” Checking PR #${{ github.event.pull_request.number }} status..."
    
    API_URL="${{ github.event.pull_request.url }}"
    MAX_RETRIES=5
    RETRY_DELAY=3
    
    for i in $(seq 1 $MAX_RETRIES); do
      echo "Attempt $i/$MAX_RETRIES..."
      
      body=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   -H "Accept: application/vnd.github.v3+json" \
                   "$API_URL")
      
      echo "API URL: $API_URL"
      echo "HTTP status code: $(curl -s -o /dev/null -w '%{http_code}' \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$API_URL")"
      
      state=$(echo "$body" | jq -r '.state')
      mergeable=$(echo "$body" | jq -r '.mergeable')
      mergeable_state=$(echo "$body" | jq -r '.mergeable_state')
      
      echo "PR State: $state"
      echo "Mergeable: $mergeable"
      echo "Mergeable State: $mergeable_state"
      
      # å¦‚æœ mergeable ä¸æ˜¯ nullï¼Œè·³å‡ºå¾ªç¯
      if [[ "$mergeable" != "null" && "$mergeable" != "" ]]; then
        echo "âœ… Got valid mergeable status"
        break
      fi
      
      if [[ $i -lt $MAX_RETRIES ]]; then
        echo "â³ Mergeable status is null/unknown, retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
      else
        echo "âŒ Failed to get mergeable status after $MAX_RETRIES attempts"
        exit 1
      fi
    done
    
    # æ£€æŸ¥ PR çŠ¶æ€
    if [[ "$state" != "open" ]]; then
      echo "âŒ PR is not open (state: $state)"
      exit 1
    fi
    
    # æ£€æŸ¥æ˜¯å¦å¯åˆå¹¶
    if [[ "$mergeable" != "true" ]]; then
      echo "âŒ PR is not mergeable (mergeable: $mergeable, state: $mergeable_state)"
      exit 1
    fi
    
    echo "âœ… PR is open and ready for merge"
    echo "MERGEABLE_CHECK=true" >> $GITHUB_OUTPUT
```

**å…³é”®æ”¹è¿›ï¼š**

1. **é‡è¯•é€»è¾‘**ï¼šæœ€å¤šé‡è¯• 5 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 3 ç§’
1. **æ£€æŸ¥ null**ï¼šåˆ¤æ–­ `mergeable` æ˜¯å¦ä¸º `null` æˆ–ç©º
1. **åŠæ—¶é€€å‡º**ï¼šä¸€æ—¦è·å¾—æœ‰æ•ˆå€¼å°±åœæ­¢é‡è¯•
1. **æ¸…æ™°æ—¥å¿—**ï¼šæ˜¾ç¤ºæ¯æ¬¡å°è¯•çš„çŠ¶æ€

**å…¶ä»–å»ºè®®ï¼š**

ä½ ä¹Ÿå¯ä»¥åœ¨ workflow å¼€å¤´æ·»åŠ ä¸€ä¸ªå°å»¶è¿Ÿï¼Œç»™ GitHub æ—¶é—´è®¡ç®—çŠ¶æ€ï¼š

```yaml
- name: Wait for mergeable status
  run: sleep 5

- name: Check PR Status Before Merge
  # ... ä½ çš„æ£€æŸ¥é€»è¾‘
```

**ä¸ºä»€ä¹ˆç¬¬äºŒæ¬¡å°±æˆåŠŸäº†ï¼Ÿ**
å› ä¸ºç¬¬ä¸€æ¬¡è¿è¡Œè§¦å‘äº† GitHub çš„è®¡ç®—ï¼Œç­‰ä½ ç¬¬äºŒæ¬¡æ‰‹åŠ¨é‡æ–°è¿è¡Œæ—¶ï¼ŒçŠ¶æ€å·²ç»è®¡ç®—å®Œæˆå¹¶ç¼“å­˜äº†ï¼Œæ‰€ä»¥ç«‹å³å¾—åˆ° `clean` çš„ç»“æœã€‚â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹

çœ‹åˆ°äº†ï¼Œmerge API è°ƒç”¨æˆåŠŸäº†ï¼ˆPR è¢«åˆå¹¶ï¼‰ï¼Œä½†æ˜¯å“åº”è§£æå¤±è´¥å¯¼è‡´ job æ ‡è®°ä¸ºå¤±è´¥ã€‚æˆ‘æ¥å¸®ä½ æ·»åŠ é‡è¯•é€»è¾‘å’Œæ›´å¥½çš„å“åº”å¤„ç†ï¼š

```yaml
- name: Merge Pull Request
  if: ${{ steps.check_pr_status.outputs.MERGEABLE_CHECK == 'true' }}
  run: |
    echo "ğŸš€ Attempting to merge PR #${{ inputs.pull_number }} using ${{ inputs.merge_method }} method..."
    
    MERGE_API_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/pulls/${{ inputs.pull_number }}/merge"
    echo "Merge URL: $MERGE_API_URL"
    
    MAX_RETRIES=3
    RETRY_DELAY=2
    MERGED=false
    
    for i in $(seq 1 $MAX_RETRIES); do
      echo "----------------------------------------"
      echo "Merge attempt $i/$MAX_RETRIES..."
      
      http_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -L \
        -X PUT \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "$MERGE_API_URL" \
        -d '{
          "commit_title": "Auto merge PR #${{ inputs.pull_number }}",
          "commit_message": "Merged via GitHub Actions workflow test",
          "merge_method": "${{ inputs.merge_method }}"
        }')
      
      http_code=$(echo "$http_response" | grep "HTTP_CODE:" | cut -d: -f2)
      body=$(echo "$http_response" | grep -v "HTTP_CODE:")
      
      echo "Response Code: $http_code"
      echo "Response Body: $body"
      
      # æ£€æŸ¥ HTTP çŠ¶æ€ç 
      if [[ "$http_code" == "200" ]]; then
        echo "âœ… PR merged successfully (HTTP 200)"
        MERGED=true
        break
      elif [[ "$http_code" == "405" ]]; then
        # 405 å¯èƒ½æ„å‘³ç€ PR å·²ç»è¢«åˆå¹¶äº†
        echo "âš ï¸ Got HTTP 405 - checking if PR is already merged..."
        
        # æ£€æŸ¥ PR çŠ¶æ€
        pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                         -H "Accept: application/vnd.github+json" \
                         "${{ github.event.pull_request.url }}")
        
        merged=$(echo "$pr_status" | jq -r '.merged')
        pr_state=$(echo "$pr_status" | jq -r '.state')
        
        echo "PR merged status: $merged"
        echo "PR state: $pr_state"
        
        if [[ "$merged" == "true" ]]; then
          echo "âœ… PR is already merged!"
          MERGED=true
          break
        else
          echo "âŒ PR is not merged and got 405 error"
        fi
      elif [[ "$http_code" == "409" ]]; then
        echo "âš ï¸ Merge conflict detected (HTTP 409)"
        echo "âŒ Cannot merge due to conflicts"
        exit 1
      elif [[ "$http_code" == "" || "$http_code" == "null" ]]; then
        echo "âš ï¸ Empty response code, checking PR merge status..."
        
        # æ£€æŸ¥ PR æ˜¯å¦å®é™…è¢«åˆå¹¶äº†
        sleep 2
        pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                         -H "Accept: application/vnd.github+json" \
                         "${{ github.event.pull_request.url }}")
        
        merged=$(echo "$pr_status" | jq -r '.merged')
        
        if [[ "$merged" == "true" ]]; then
          echo "âœ… PR was successfully merged (verified by status check)"
          MERGED=true
          break
        else
          echo "â³ PR not merged yet, will retry..."
        fi
      else
        echo "âš ï¸ Unexpected HTTP code: $http_code"
      fi
      
      if [[ $i -lt $MAX_RETRIES ]]; then
        echo "â³ Retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
      fi
    done
    
    # æœ€ç»ˆéªŒè¯
    if [[ "$MERGED" == "false" ]]; then
      echo "----------------------------------------"
      echo "ğŸ” Final verification: checking PR merge status..."
      
      pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                       -H "Accept: application/vnd.github+json" \
                       "${{ github.event.pull_request.url }}")
      
      merged=$(echo "$pr_status" | jq -r '.merged')
      merge_commit_sha=$(echo "$pr_status" | jq -r '.merge_commit_sha')
      
      if [[ "$merged" == "true" ]]; then
        echo "âœ… PR #${{ inputs.pull_number }} is confirmed merged!"
        echo "Merge commit: $merge_commit_sha"
        MERGED=true
      else
        echo "âŒ Failed to merge PR after $MAX_RETRIES attempts"
        exit 1
      fi
    fi
    
    if [[ "$MERGED" == "true" ]]; then
      echo "========================================="
      echo "ğŸ‰ PR #${{ inputs.pull_number }} successfully merged!"
      echo "========================================="
    fi
```

**ä¸»è¦æ”¹è¿›ï¼š**

1. **é‡è¯•é€»è¾‘**ï¼šæœ€å¤šå°è¯• 3 æ¬¡åˆå¹¶
1. **ç©ºå“åº”å¤„ç†**ï¼šå½“ `http_code` ä¸ºç©ºæ—¶ï¼Œä¸»åŠ¨æŸ¥è¯¢ PR çŠ¶æ€ç¡®è®¤æ˜¯å¦å·²åˆå¹¶
1. **HTTP 405 å¤„ç†**ï¼šå¯èƒ½è¡¨ç¤º PR å·²è¢«åˆå¹¶ï¼Œä¼šå†æ¬¡ç¡®è®¤
1. **HTTP 409 å¤„ç†**ï¼šåˆå¹¶å†²çªï¼Œç›´æ¥å¤±è´¥
1. **æœ€ç»ˆéªŒè¯**ï¼šå³ä½¿æ‰€æœ‰å°è¯•çœ‹èµ·æ¥å¤±è´¥ï¼Œæœ€åè¿˜ä¼šæŸ¥è¯¢ä¸€æ¬¡ PR çŠ¶æ€ç¡®è®¤
1. **æ›´æ¸…æ™°çš„æ—¥å¿—**ï¼šæ¯ä¸€æ­¥éƒ½æœ‰æ˜ç¡®çš„è¾“å‡º

**å…³é”®ç‚¹ï¼š**

- å³ä½¿ API å“åº”ä¸ºç©ºæˆ–å¼‚å¸¸ï¼Œåªè¦ PR å®é™…è¢«åˆå¹¶äº†ï¼ˆ`merged: true`ï¼‰ï¼Œjob å°±ä¼šæˆåŠŸ
- ä½¿ç”¨ `${{ github.event.pull_request.url }}` ç›´æ¥è·å– PR è¯¦æƒ…æ¥éªŒè¯åˆå¹¶çŠ¶æ€
- æ·»åŠ äº†å»¶è¿Ÿï¼ˆ`sleep 2`ï¼‰ç»™ GitHub æ—¶é—´å¤„ç†åˆå¹¶æ“ä½œ

è¿™æ ·å³ä½¿é‡åˆ°å“åº”è§£æé—®é¢˜ï¼Œåªè¦ PR è¢«æˆåŠŸåˆå¹¶ï¼Œworkflow å°±ä¸ä¼šå¤±è´¥ã€‚â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹â€‹