- name: Check PR Status Before Merge
  id: check_pr_status
  run: |
    echo "üîç Checking PR #${{ github.event.pull_request.number }} status..."
    
    API_URL="${{ github.event.pull_request.url }}"
    MAX_RETRIES=5
    RETRY_DELAY=3
    
    for i in $(seq 1 $MAX_RETRIES); do
      echo "Attempt $i/$MAX_RETRIES..."
      
      body=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   -H "Accept: application/vnd.github.v3+json" \
                   "$API_URL")
      
      echo "API URL: $API_URL"
      echo "HTTP status code: $(curl -s -o /dev/null -w '%{http_code}' \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$API_URL")"
      
      state=$(echo "$body" | jq -r '.state')
      mergeable=$(echo "$body" | jq -r '.mergeable')
      mergeable_state=$(echo "$body" | jq -r '.mergeable_state')
      
      echo "PR State: $state"
      echo "Mergeable: $mergeable"
      echo "Mergeable State: $mergeable_state"
      
      # Â¶ÇÊûú mergeable ‰∏çÊòØ nullÔºåË∑≥Âá∫Âæ™ÁéØ
      if [[ "$mergeable" != "null" && "$mergeable" != "" ]]; then
        echo "‚úÖ Got valid mergeable status"
        break
      fi
      
      if [[ $i -lt $MAX_RETRIES ]]; then
        echo "‚è≥ Mergeable status is null/unknown, retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
      else
        echo "‚ùå Failed to get mergeable status after $MAX_RETRIES attempts"
        exit 1
      fi
    done
    
    # Ê£ÄÊü• PR Áä∂ÊÄÅ
    if [[ "$state" != "open" ]]; then
      echo "‚ùå PR is not open (state: $state)"
      exit 1
    fi
    
    # Ê£ÄÊü•ÊòØÂê¶ÂèØÂêàÂπ∂
    if [[ "$mergeable" != "true" ]]; then
      echo "‚ùå PR is not mergeable (mergeable: $mergeable, state: $mergeable_state)"
      exit 1
    fi
    
    echo "‚úÖ PR is open and ready for merge"
    echo "MERGEABLE_CHECK=true" >> $GITHUB_OUTPUT

- name: Merge Pull Request
  if: ${{ steps.check_pr_status.outputs.MERGEABLE_CHECK == 'true' }}
  run: |
    echo "üöÄ Attempting to merge PR #${{ inputs.pull_number }} using ${{ inputs.merge_method }} method..."
    
    MERGE_API_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/pulls/${{ inputs.pull_number }}/merge"
    echo "Merge URL: $MERGE_API_URL"
    
    MAX_RETRIES=3
    RETRY_DELAY=2
    MERGED=false
    
    for i in $(seq 1 $MAX_RETRIES); do
      echo "----------------------------------------"
      echo "Merge attempt $i/$MAX_RETRIES..."
      
      http_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -L \
        -X PUT \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "$MERGE_API_URL" \
        -d '{
          "commit_title": "Auto merge PR #${{ inputs.pull_number }}",
          "commit_message": "Merged via GitHub Actions workflow test",
          "merge_method": "${{ inputs.merge_method }}"
        }')
      
      http_code=$(echo "$http_response" | grep "HTTP_CODE:" | cut -d: -f2)
      body=$(echo "$http_response" | grep -v "HTTP_CODE:")
      
      echo "Response Code: $http_code"
      echo "Response Body: $body"
      
      # Ê£ÄÊü• HTTP Áä∂ÊÄÅÁ†Å
      if [[ "$http_code" == "200" ]]; then
        echo "‚úÖ PR merged successfully (HTTP 200)"
        MERGED=true
        break
      elif [[ "$http_code" == "405" ]]; then
        # 405 ÂèØËÉΩÊÑèÂë≥ÁùÄ PR Â∑≤ÁªèË¢´ÂêàÂπ∂‰∫Ü
        echo "‚ö†Ô∏è Got HTTP 405 - checking if PR is already merged..."
        
        # Ê£ÄÊü• PR Áä∂ÊÄÅ
        pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                         -H "Accept: application/vnd.github+json" \
                         "${{ github.event.pull_request.url }}")
        
        merged=$(echo "$pr_status" | jq -r '.merged')
        pr_state=$(echo "$pr_status" | jq -r '.state')
        
        echo "PR merged status: $merged"
        echo "PR state: $pr_state"
        
        if [[ "$merged" == "true" ]]; then
          echo "‚úÖ PR is already merged!"
          MERGED=true
          break
        else
          echo "‚ùå PR is not merged and got 405 error"
        fi
      elif [[ "$http_code" == "409" ]]; then
        echo "‚ö†Ô∏è Merge conflict detected (HTTP 409)"
        echo "‚ùå Cannot merge due to conflicts"
        exit 1
      elif [[ "$http_code" == "" || "$http_code" == "null" ]]; then
        echo "‚ö†Ô∏è Empty response code, checking PR merge status..."
        
        # Ê£ÄÊü• PR ÊòØÂê¶ÂÆûÈôÖË¢´ÂêàÂπ∂‰∫Ü
        sleep 2
        pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                         -H "Accept: application/vnd.github+json" \
                         "${{ github.event.pull_request.url }}")
        
        merged=$(echo "$pr_status" | jq -r '.merged')
        
        if [[ "$merged" == "true" ]]; then
          echo "‚úÖ PR was successfully merged (verified by status check)"
          MERGED=true
          break
        else
          echo "‚è≥ PR not merged yet, will retry..."
        fi
      else
        echo "‚ö†Ô∏è Unexpected HTTP code: $http_code"
      fi
      
      if [[ $i -lt $MAX_RETRIES ]]; then
        echo "‚è≥ Retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
      fi
    done
    
    # ÊúÄÁªàÈ™åËØÅ
    if [[ "$MERGED" == "false" ]]; then
      echo "----------------------------------------"
      echo "üîç Final verification: checking PR merge status..."
      
      pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                       -H "Accept: application/vnd.github+json" \
                       "${{ github.event.pull_request.url }}")
      
      merged=$(echo "$pr_status" | jq -r '.merged')
      merge_commit_sha=$(echo "$pr_status" | jq -r '.merge_commit_sha')
      
      if [[ "$merged" == "true" ]]; then
        echo "‚úÖ PR #${{ inputs.pull_number }} is confirmed merged!"
        echo "Merge commit: $merge_commit_sha"
        MERGED=true
      else
        echo "‚ùå Failed to merge PR after $MAX_RETRIES attempts"
        exit 1
      fi
    fi
    
    if [[ "$MERGED" == "true" ]]; then
      echo "========================================="
      echo "üéâ PR #${{ inputs.pull_number }} successfully merged!"
      echo "========================================="
    fi

ËøôÊòØ‰∏Ä‰∏™ÂæàÂ∏∏ËßÅÁöÑ GitHub API ÈóÆÈ¢òÔºÅ`mergeable` Âíå `mergeable_state` Â≠óÊÆµÁªèÂ∏∏Âú®Á¨¨‰∏ÄÊ¨°ËØ∑Ê±ÇÊó∂ËøîÂõû `null` Êàñ `unknown`„ÄÇ

**ÂéüÂõ†Ôºö**

GitHub ÈúÄË¶Å**ÂºÇÊ≠•ËÆ°ÁÆó** PR ÁöÑÂèØÂêàÂπ∂Áä∂ÊÄÅ„ÄÇÂΩì‰Ω†Á¨¨‰∏ÄÊ¨°ËØ∑Ê±Ç PR ‰ø°ÊÅØÊó∂Ôºö

1. GitHub API Á´ãÂç≥ËøîÂõûÂìçÂ∫îÔºà`mergeable: null`, `mergeable_state: unknown`Ôºâ
1. GitHub Âú®ÂêéÂè∞ÂºÄÂßãËÆ°ÁÆóÂêàÂπ∂Áä∂ÊÄÅÔºàÊ£ÄÊü•ÂÜ≤Á™Å„ÄÅCI Áä∂ÊÄÅÁ≠âÔºâ
1. Âá†ÁßíÈíüÂêéÔºåËÆ°ÁÆóÂÆåÊàêÔºåÂÜçÊ¨°ËØ∑Ê±ÇÂ∞±ËÉΩÂæóÂà∞Ê≠£Á°ÆÁöÑÂÄº

**Ëß£ÂÜ≥ÊñπÊ°àÔºöÊ∑ªÂä†ÈáçËØïÈÄªËæë**

```yaml
- name: Check PR Status Before Merge
  id: check_pr_status
  run: |
    echo "üîç Checking PR #${{ github.event.pull_request.number }} status..."
    
    API_URL="${{ github.event.pull_request.url }}"
    MAX_RETRIES=5
    RETRY_DELAY=3
    
    for i in $(seq 1 $MAX_RETRIES); do
      echo "Attempt $i/$MAX_RETRIES..."
      
      body=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                   -H "Accept: application/vnd.github.v3+json" \
                   "$API_URL")
      
      echo "API URL: $API_URL"
      echo "HTTP status code: $(curl -s -o /dev/null -w '%{http_code}' \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "$API_URL")"
      
      state=$(echo "$body" | jq -r '.state')
      mergeable=$(echo "$body" | jq -r '.mergeable')
      mergeable_state=$(echo "$body" | jq -r '.mergeable_state')
      
      echo "PR State: $state"
      echo "Mergeable: $mergeable"
      echo "Mergeable State: $mergeable_state"
      
      # Â¶ÇÊûú mergeable ‰∏çÊòØ nullÔºåË∑≥Âá∫Âæ™ÁéØ
      if [[ "$mergeable" != "null" && "$mergeable" != "" ]]; then
        echo "‚úÖ Got valid mergeable status"
        break
      fi
      
      if [[ $i -lt $MAX_RETRIES ]]; then
        echo "‚è≥ Mergeable status is null/unknown, retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
      else
        echo "‚ùå Failed to get mergeable status after $MAX_RETRIES attempts"
        exit 1
      fi
    done
    
    # Ê£ÄÊü• PR Áä∂ÊÄÅ
    if [[ "$state" != "open" ]]; then
      echo "‚ùå PR is not open (state: $state)"
      exit 1
    fi
    
    # Ê£ÄÊü•ÊòØÂê¶ÂèØÂêàÂπ∂
    if [[ "$mergeable" != "true" ]]; then
      echo "‚ùå PR is not mergeable (mergeable: $mergeable, state: $mergeable_state)"
      exit 1
    fi
    
    echo "‚úÖ PR is open and ready for merge"
    echo "MERGEABLE_CHECK=true" >> $GITHUB_OUTPUT
```

**ÂÖ≥ÈîÆÊîπËøõÔºö**

1. **ÈáçËØïÈÄªËæë**ÔºöÊúÄÂ§öÈáçËØï 5 Ê¨°ÔºåÊØèÊ¨°Èó¥Èöî 3 Áßí
1. **Ê£ÄÊü• null**ÔºöÂà§Êñ≠ `mergeable` ÊòØÂê¶‰∏∫ `null` ÊàñÁ©∫
1. **ÂèäÊó∂ÈÄÄÂá∫**Ôºö‰∏ÄÊó¶Ëé∑ÂæóÊúâÊïàÂÄºÂ∞±ÂÅúÊ≠¢ÈáçËØï
1. **Ê∏ÖÊô∞Êó•Âøó**ÔºöÊòæÁ§∫ÊØèÊ¨°Â∞ùËØïÁöÑÁä∂ÊÄÅ

**ÂÖ∂‰ªñÂª∫ËÆÆÔºö**

‰Ω†‰πüÂèØ‰ª•Âú® workflow ÂºÄÂ§¥Ê∑ªÂä†‰∏Ä‰∏™Â∞èÂª∂ËøüÔºåÁªô GitHub Êó∂Èó¥ËÆ°ÁÆóÁä∂ÊÄÅÔºö

```yaml
- name: Wait for mergeable status
  run: sleep 5

- name: Check PR Status Before Merge
  # ... ‰Ω†ÁöÑÊ£ÄÊü•ÈÄªËæë
```

**‰∏∫‰ªÄ‰πàÁ¨¨‰∫åÊ¨°Â∞±ÊàêÂäü‰∫ÜÔºü**
Âõ†‰∏∫Á¨¨‰∏ÄÊ¨°ËøêË°åËß¶Âèë‰∫Ü GitHub ÁöÑËÆ°ÁÆóÔºåÁ≠â‰Ω†Á¨¨‰∫åÊ¨°ÊâãÂä®ÈáçÊñ∞ËøêË°åÊó∂ÔºåÁä∂ÊÄÅÂ∑≤ÁªèËÆ°ÁÆóÂÆåÊàêÂπ∂ÁºìÂ≠ò‰∫ÜÔºåÊâÄ‰ª•Á´ãÂç≥ÂæóÂà∞ `clean` ÁöÑÁªìÊûú„ÄÇ‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã

ÁúãÂà∞‰∫ÜÔºåmerge API Ë∞ÉÁî®ÊàêÂäü‰∫ÜÔºàPR Ë¢´ÂêàÂπ∂ÔºâÔºå‰ΩÜÊòØÂìçÂ∫îËß£ÊûêÂ§±Ë¥•ÂØºËá¥ job Ê†áËÆ∞‰∏∫Â§±Ë¥•„ÄÇÊàëÊù•Â∏Æ‰Ω†Ê∑ªÂä†ÈáçËØïÈÄªËæëÂíåÊõ¥Â•ΩÁöÑÂìçÂ∫îÂ§ÑÁêÜÔºö

```yaml
- name: Merge Pull Request
  if: ${{ steps.check_pr_status.outputs.MERGEABLE_CHECK == 'true' }}
  run: |
    echo "üöÄ Attempting to merge PR #${{ inputs.pull_number }} using ${{ inputs.merge_method }} method..."
    
    MERGE_API_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/pulls/${{ inputs.pull_number }}/merge"
    echo "Merge URL: $MERGE_API_URL"
    
    MAX_RETRIES=3
    RETRY_DELAY=2
    MERGED=false
    
    for i in $(seq 1 $MAX_RETRIES); do
      echo "----------------------------------------"
      echo "Merge attempt $i/$MAX_RETRIES..."
      
      http_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -L \
        -X PUT \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "$MERGE_API_URL" \
        -d '{
          "commit_title": "Auto merge PR #${{ inputs.pull_number }}",
          "commit_message": "Merged via GitHub Actions workflow test",
          "merge_method": "${{ inputs.merge_method }}"
        }')
      
      http_code=$(echo "$http_response" | grep "HTTP_CODE:" | cut -d: -f2)
      body=$(echo "$http_response" | grep -v "HTTP_CODE:")
      
      echo "Response Code: $http_code"
      echo "Response Body: $body"
      
      # Ê£ÄÊü• HTTP Áä∂ÊÄÅÁ†Å
      if [[ "$http_code" == "200" ]]; then
        echo "‚úÖ PR merged successfully (HTTP 200)"
        MERGED=true
        break
      elif [[ "$http_code" == "405" ]]; then
        # 405 ÂèØËÉΩÊÑèÂë≥ÁùÄ PR Â∑≤ÁªèË¢´ÂêàÂπ∂‰∫Ü
        echo "‚ö†Ô∏è Got HTTP 405 - checking if PR is already merged..."
        
        # Ê£ÄÊü• PR Áä∂ÊÄÅ
        pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                         -H "Accept: application/vnd.github+json" \
                         "${{ github.event.pull_request.url }}")
        
        merged=$(echo "$pr_status" | jq -r '.merged')
        pr_state=$(echo "$pr_status" | jq -r '.state')
        
        echo "PR merged status: $merged"
        echo "PR state: $pr_state"
        
        if [[ "$merged" == "true" ]]; then
          echo "‚úÖ PR is already merged!"
          MERGED=true
          break
        else
          echo "‚ùå PR is not merged and got 405 error"
        fi
      elif [[ "$http_code" == "409" ]]; then
        echo "‚ö†Ô∏è Merge conflict detected (HTTP 409)"
        echo "‚ùå Cannot merge due to conflicts"
        exit 1
      elif [[ "$http_code" == "" || "$http_code" == "null" ]]; then
        echo "‚ö†Ô∏è Empty response code, checking PR merge status..."
        
        # Ê£ÄÊü• PR ÊòØÂê¶ÂÆûÈôÖË¢´ÂêàÂπ∂‰∫Ü
        sleep 2
        pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                         -H "Accept: application/vnd.github+json" \
                         "${{ github.event.pull_request.url }}")
        
        merged=$(echo "$pr_status" | jq -r '.merged')
        
        if [[ "$merged" == "true" ]]; then
          echo "‚úÖ PR was successfully merged (verified by status check)"
          MERGED=true
          break
        else
          echo "‚è≥ PR not merged yet, will retry..."
        fi
      else
        echo "‚ö†Ô∏è Unexpected HTTP code: $http_code"
      fi
      
      if [[ $i -lt $MAX_RETRIES ]]; then
        echo "‚è≥ Retrying in ${RETRY_DELAY}s..."
        sleep $RETRY_DELAY
      fi
    done
    
    # ÊúÄÁªàÈ™åËØÅ
    if [[ "$MERGED" == "false" ]]; then
      echo "----------------------------------------"
      echo "üîç Final verification: checking PR merge status..."
      
      pr_status=$(curl -s -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
                       -H "Accept: application/vnd.github+json" \
                       "${{ github.event.pull_request.url }}")
      
      merged=$(echo "$pr_status" | jq -r '.merged')
      merge_commit_sha=$(echo "$pr_status" | jq -r '.merge_commit_sha')
      
      if [[ "$merged" == "true" ]]; then
        echo "‚úÖ PR #${{ inputs.pull_number }} is confirmed merged!"
        echo "Merge commit: $merge_commit_sha"
        MERGED=true
      else
        echo "‚ùå Failed to merge PR after $MAX_RETRIES attempts"
        exit 1
      fi
    fi
    
    if [[ "$MERGED" == "true" ]]; then
      echo "========================================="
      echo "üéâ PR #${{ inputs.pull_number }} successfully merged!"
      echo "========================================="
    fi
```

**‰∏ªË¶ÅÊîπËøõÔºö**

1. **ÈáçËØïÈÄªËæë**ÔºöÊúÄÂ§öÂ∞ùËØï 3 Ê¨°ÂêàÂπ∂
1. **Á©∫ÂìçÂ∫îÂ§ÑÁêÜ**ÔºöÂΩì `http_code` ‰∏∫Á©∫Êó∂Ôºå‰∏ªÂä®Êü•ËØ¢ PR Áä∂ÊÄÅÁ°ÆËÆ§ÊòØÂê¶Â∑≤ÂêàÂπ∂
1. **HTTP 405 Â§ÑÁêÜ**ÔºöÂèØËÉΩË°®Á§∫ PR Â∑≤Ë¢´ÂêàÂπ∂Ôºå‰ºöÂÜçÊ¨°Á°ÆËÆ§
1. **HTTP 409 Â§ÑÁêÜ**ÔºöÂêàÂπ∂ÂÜ≤Á™ÅÔºåÁõ¥Êé•Â§±Ë¥•
1. **ÊúÄÁªàÈ™åËØÅ**ÔºöÂç≥‰ΩøÊâÄÊúâÂ∞ùËØïÁúãËµ∑Êù•Â§±Ë¥•ÔºåÊúÄÂêéËøò‰ºöÊü•ËØ¢‰∏ÄÊ¨° PR Áä∂ÊÄÅÁ°ÆËÆ§
1. **Êõ¥Ê∏ÖÊô∞ÁöÑÊó•Âøó**ÔºöÊØè‰∏ÄÊ≠•ÈÉΩÊúâÊòéÁ°ÆÁöÑËæìÂá∫

**ÂÖ≥ÈîÆÁÇπÔºö**

- Âç≥‰Ωø API ÂìçÂ∫î‰∏∫Á©∫ÊàñÂºÇÂ∏∏ÔºåÂè™Ë¶Å PR ÂÆûÈôÖË¢´ÂêàÂπ∂‰∫ÜÔºà`merged: true`ÔºâÔºåjob Â∞±‰ºöÊàêÂäü
- ‰ΩøÁî® `${{ github.event.pull_request.url }}` Áõ¥Êé•Ëé∑Âèñ PR ËØ¶ÊÉÖÊù•È™åËØÅÂêàÂπ∂Áä∂ÊÄÅ
- Ê∑ªÂä†‰∫ÜÂª∂ËøüÔºà`sleep 2`ÔºâÁªô GitHub Êó∂Èó¥Â§ÑÁêÜÂêàÂπ∂Êìç‰Ωú


ËøôÊ†∑Âç≥‰ΩøÈÅáÂà∞ÂìçÂ∫îËß£ÊûêÈóÆÈ¢òÔºåÂè™Ë¶Å PR Ë¢´ÊàêÂäüÂêàÂπ∂Ôºåworkflow Â∞±‰∏ç‰ºöÂ§±Ë¥•„ÄÇ‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã

```
  - name: Check PR Status Before Merge
    id: check_pr_status
    run: |
      echo "üîç Checking PR ${{ env.PR_NUMBER }} status..."
      API_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/pulls/${{ env.PR_NUMBER }}"
      echo "API URL: $API_URL"
      MAX_RETRIES=5
      RETRY_DELAY=3

      for i in $(seq 1 $MAX_RETRIES); do
        echo "Attempt $i/$MAX_RETRIES..."
        http_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -L \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.TDUNPIDPAT }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "$API_URL")

        http_code=$(echo "$http_response" | grep "HTTP_CODE:" | cut -d: -f2)
        body=$(echo "$http_response" | grep -v "HTTP_CODE:")
        echo "HTTP status code: $http_code"
        state=$(echo "$body" | jq -r '.state')
        mergeable=$(echo "$body" | jq -r '.mergeable')
        mergeable_state=$(echo "$body" | jq -r '.mergeable_state')

        echo "PR State: $state"
        echo "Mergeable: $mergeable"
        echo "Mergeable State: $mergeable_state"

        if [ "$mergeable" != "null" ]; then
          break
        fi
        echo "Mergeable is null, retrying in $RETRY_DELAY seconds..."
        sleep $RETRY_DELAY
      done

      if [ "$state" != "open" ]; then
        echo "‚ùå PR is not open (state: $state). Skipping."
        echo "ready=false" >> $GITHUB_OUTPUT
        exit 0
      fi
    shell: bash

  - name: Check All Required Status Checks
    id: check_runs_status
    run: |
      echo "üîç Checking all check runs for PR #${{ env.PR_NUMBER }}..."

      # Get PR head SHA
      PR_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/pulls/${{ env.PR_NUMBER }}"
      pr_body=$(curl -s -L \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.TDUNPIDPAT }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "$PR_URL")

      HEAD_SHA=$(echo "$pr_body" | jq -r '.head.sha')
      BASE_BRANCH=$(echo "$pr_body" | jq -r '.base.ref')
      echo "HEAD SHA: $HEAD_SHA"
      echo "Base Branch: $BASE_BRANCH"

      # -------------------------------------------------------
      # 1. Get all check runs for this commit
      # -------------------------------------------------------
      CHECK_RUNS_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/commits/${HEAD_SHA}/check-runs?per_page=100"
      echo "Fetching check runs from: $CHECK_RUNS_URL"

      check_runs_body=$(curl -s -L \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.TDUNPIDPAT }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "$CHECK_RUNS_URL")

      total_count=$(echo "$check_runs_body" | jq -r '.total_count')
      echo "Total check runs: $total_count"

      # Print all check runs for debugging
      echo ""
      echo "========== All Check Runs =========="
      echo "$check_runs_body" | jq -r '.check_runs[] | "  [\(.status)] \(.name) => \(.conclusion // "pending")"'
      echo "===================================="
      echo ""

      # -------------------------------------------------------
      # 2. Get required status checks from branch protection
      # -------------------------------------------------------
      PROTECTION_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/branches/${BASE_BRANCH}/protection/required_status_checks"
      echo "Fetching required checks from: $PROTECTION_URL"

      protection_body=$(curl -s -L \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.TDUNPIDPAT }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "$PROTECTION_URL")

      protection_http_code=$(echo "$protection_body" | jq -r '.message // empty')

      if [ -n "$protection_http_code" ]; then
        echo "‚ö†Ô∏è  Could not fetch branch protection rules: $protection_http_code"
        echo "Falling back to checking ALL check runs..."
        REQUIRED_CHECKS=""
      else
        # Extract required check names (from both 'contexts' and 'checks' arrays)
        REQUIRED_CHECKS=$(echo "$protection_body" | jq -r '
          ((.contexts // []) + ((.checks // []) | map(.context))) | unique | .[]
        ')
        echo "Required checks:"
        echo "$REQUIRED_CHECKS" | while read -r check; do
          [ -n "$check" ] && echo "  - $check"
        done
      fi

      # -------------------------------------------------------
      # 3. Validate check run results
      # -------------------------------------------------------
      FAILED=""
      PENDING=""
      PASSED=""

      if [ -n "$REQUIRED_CHECKS" ]; then
        # Check only required checks
        echo ""
        echo "Validating required checks..."
        while IFS= read -r required_check; do
          [ -z "$required_check" ] && continue

          # Skip our own workflow to avoid circular dependency
          if echo "$required_check" | grep -qi "auto.merge"; then
            echo "  ‚è≠Ô∏è  Skipping self: $required_check"
            continue
          fi

          # Find this check in the check runs
          check_status=$(echo "$check_runs_body" | jq -r --arg name "$required_check" '
            .check_runs[] | select(.name == $name) | "\(.status)|\(.conclusion // "null")"
          ' | head -1)

          if [ -z "$check_status" ]; then
            PENDING="${PENDING}${required_check} (not found yet)\n"
          else
            status=$(echo "$check_status" | cut -d'|' -f1)
            conclusion=$(echo "$check_status" | cut -d'|' -f2)

            if [ "$status" != "completed" ]; then
              PENDING="${PENDING}${required_check} (${status})\n"
            elif [ "$conclusion" = "success" ] || [ "$conclusion" = "skipped" ]; then
              PASSED="${PASSED}${required_check}\n"
            else
              FAILED="${FAILED}${required_check} (${conclusion})\n"
            fi
          fi
        done <<< "$REQUIRED_CHECKS"
      else
        # No required checks found - check ALL runs (excluding self)
        echo ""
        echo "No required checks defined. Validating all check runs..."
        while IFS= read -r line; do
          [ -z "$line" ] && continue
          name=$(echo "$line" | cut -d'|' -f1)
          status=$(echo "$line" | cut -d'|' -f2)
          conclusion=$(echo "$line" | cut -d'|' -f3)

          # Skip our own workflow
          if echo "$name" | grep -qi "auto.merge"; then
            echo "  ‚è≠Ô∏è  Skipping self: $name"
            continue
          fi

          if [ "$status" != "completed" ]; then
            PENDING="${PENDING}${name} (${status})\n"
          elif [ "$conclusion" = "success" ] || [ "$conclusion" = "skipped" ]; then
            PASSED="${PASSED}${name}\n"
          else
            FAILED="${FAILED}${name} (${conclusion})\n"
          fi
        done <<< "$(echo "$check_runs_body" | jq -r '.check_runs[] | "\(.name)|\(.status)|\(.conclusion // "null")"')"
      fi

      # -------------------------------------------------------
      # 4. Check review approval status
      # -------------------------------------------------------
      echo ""
      echo "Checking review approval status..."
      REVIEWS_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/pulls/${{ env.PR_NUMBER }}/reviews"
      reviews_body=$(curl -s -L \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.TDUNPIDPAT }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        "$REVIEWS_URL")

      approved=$(echo "$reviews_body" | jq '[.[] | select(.state == "APPROVED")] | length')
      echo "Approved reviews: $approved"

      # -------------------------------------------------------
      # 5. Final decision
      # -------------------------------------------------------
      echo ""
      echo "========== Summary =========="
      if [ -n "$PASSED" ]; then
        echo "‚úÖ Passed:"
        echo -e "$PASSED" | while read -r line; do [ -n "$line" ] && echo "    $line"; done
      fi
      if [ -n "$PENDING" ]; then
        echo "‚è≥ Pending:"
        echo -e "$PENDING" | while read -r line; do [ -n "$line" ] && echo "    $line"; done
      fi
      if [ -n "$FAILED" ]; then
        echo "‚ùå Failed:"
        echo -e "$FAILED" | while read -r line; do [ -n "$line" ] && echo "    $line"; done
      fi
      echo "============================="

      if [ -n "$FAILED" ]; then
        echo "‚ùå Some checks have failed. Not ready to merge."
        echo "ready=false" >> $GITHUB_OUTPUT
        exit 0
      fi

      if [ -n "$PENDING" ]; then
        echo "‚è≥ Some checks are still pending. Not ready to merge."
        echo "ready=false" >> $GITHUB_OUTPUT
        exit 0
      fi

      if [ "$approved" -lt 1 ]; then
        echo "‚ùå PR has not been approved. Not ready to merge."
        echo "ready=false" >> $GITHUB_OUTPUT
        exit 0
      fi

      echo "‚úÖ All checks passed and PR is approved! Ready to merge."
      echo "ready=true" >> $GITHUB_OUTPUT
    shell: bash

  - name: Merge PR
    if: steps.check_runs_status.outputs.ready == 'true'
    run: |
      echo "üöÄ Merging PR #${{ env.PR_NUMBER }}..."
      MERGE_URL="${{ env.GITHUB_API_URL }}/${{ env.REPO }}/pulls/${{ env.PR_NUMBER }}/merge"

      merge_response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -L \
        -X PUT \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.TDUNPIDPAT }}" \
        -H "X-GitHub-Api-Version: 2022-11-28" \
        -d '{"merge_method": "squash"}' \
        "$MERGE_URL")

      merge_http_code=$(echo "$merge_response" | grep "HTTP_CODE:" | cut -d: -f2)
      merge_body=$(echo "$merge_response" | grep -v "HTTP_CODE:")

      echo "Merge HTTP code: $merge_http_code"
      echo "Merge response: $merge_body"

      if [ "$merge_http_code" = "200" ]; then
        echo "‚úÖ PR #${{ env.PR_NUMBER }} merged successfully!"
      else
        echo "‚ùå Failed to merge PR #${{ env.PR_NUMBER }}"
        echo "Response: $merge_body"
        exit 1
      fi
    shell: bash
```