name: Test Auto Merge PR

on:
  workflow_dispatch:
    inputs:
      pull_number:
        description: 'PR number to merge'
        required: true
        type: number
      merge_method:
        description: 'Merge method'
        required: false
        default: 'squash'
        type: choice
        options:
          - merge
          - squash
          - rebase

# æƒé™é…ç½®
permissions:
  contents: write
  pull-requests: write
  repository-projects: read

jobs:
  test-merge-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Status Before Merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking PR #${{ inputs.pull_number }} status..."
          
          pr_info=$(curl -s -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ inputs.pull_number }}")
          
          echo "PR State: $(echo "$pr_info" | jq -r '.state')"
          echo "Mergeable: $(echo "$pr_info" | jq -r '.mergeable')"
          echo "Mergeable State: $(echo "$pr_info" | jq -r '.mergeable_state')"
          
          state=$(echo "$pr_info" | jq -r '.state')
          if [ "$state" != "open" ]; then
            echo "âŒ PR is not open (state: $state)"
            exit 1
          fi

      - name: Merge Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ Attempting to merge PR #${{ inputs.pull_number }} using ${{ inputs.merge_method }} method..."
          
          response=$(curl -s -w "\n%{http_code}" -L \
            -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ inputs.pull_number }}/merge" \
            -d '{
              "commit_title": "Auto merge PR #${{ inputs.pull_number }}",
              "commit_message": "Merged via GitHub Actions workflow test",
              "merge_method": "${{ inputs.merge_method }}"
            }')
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "----------------------------------------"
          echo "Response Code: $http_code"
          echo "----------------------------------------"
          
          if [ "$http_code" = "200" ]; then
            echo "âœ… Merge successful!"
            echo "$body" | jq .
          elif [ "$http_code" = "405" ]; then
            echo "âŒ Merge not allowed"
            echo "Possible reasons:"
            echo "  - PR is not mergeable (conflicts)"
            echo "  - Required status checks not passed"
            echo "  - Required reviews not approved"
            echo "$body" | jq .
            exit 1
          elif [ "$http_code" = "403" ]; then
            echo "âŒ Permission denied"
            echo "Possible reasons:"
            echo "  - Token lacks required permissions"
            echo "  - Branch protection rules blocking merge"
            echo "  - Enterprise policy restrictions"
            echo "$body" | jq .
            exit 1
          elif [ "$http_code" = "404" ]; then
            echo "âŒ PR #${{ inputs.pull_number }} not found"
            exit 1
          elif [ "$http_code" = "409" ]; then
            echo "âŒ Conflict - SHA mismatch or PR already merged"
            echo "$body" | jq .
            exit 1
          else
            echo "âŒ Unexpected response: $http_code"
            echo "$body" | jq . 2>/dev/null || echo "$body"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Merge Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR Number:** #${{ inputs.pull_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge Method:** ${{ inputs.merge_method }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
