- name: Check NPID Bypass
  id: npid_bypass
  run: |
    echo "Checking if PR qualifies for NPID bypass..."
    
    # 获取PR信息
    PR_DATA=$(curl -s \
      -H "Accept: application/vnd.github+json" \
      -H "Authorization: Bearer ${{ secrets.GHTOKEN }}" \
      -H "X-GitHub-Api-Version: 2022-11-28" \
      "${{ env.GITHUB_API_URL }}/${{ env.REPO }}/pulls/${{ inputs.pull_number }}")
    
    PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.user.login')
    BASE_BRANCH=$(echo "$PR_DATA" | jq -r '.base.ref')
    HEAD_BRANCH=$(echo "$PR_DATA" | jq -r '.head.ref')
    
    echo "PR Author: $PR_AUTHOR"
    echo "Base: $BASE_BRANCH <- Head: $HEAD_BRANCH"
    
    BYPASS="false"
    
    # 检查是否NPID账号 (改成你们实际的NPID service account名)
    if [[ "$PR_AUTHOR" == "npid-service-account" || "$PR_AUTHOR" == "NPID"* ]]; then
      # release -> release 或 release -> master
      if [[ "$HEAD_BRANCH" == release/* && "$BASE_BRANCH" == release/* ]]; then
        echo "✅ NPID bypass: release to release"
        BYPASS="true"
      elif [[ "$HEAD_BRANCH" == release/* && "$BASE_BRANCH" == "master" ]]; then
        echo "✅ NPID bypass: release to master"
        BYPASS="true"
      fi
    fi
    
    echo "NPID_BYPASS=$BYPASS" >> $GITHUB_OUTPUT
  shell: bash

- name: Merge Pull Request
  if: ${{ steps.check_pr_status.outputs.MERGEABLE_CHECK == 'true' || steps.npid_bypass.outputs.NPID_BYPASS == 'true' }}
  run: |
    # ... 你现有的merge逻辑
